!function(module){module.factory("DialogService",function(){return $(window).on("resize",function(){$("dialog").each(function(index,dialog){dialog.close(),dialog.showModal()})}),{}}).directive("dialog",["DialogService",function(DialogService){return{restrict:"E",link:function($scope,$element){$element[0].showModal()}}}]),module.factory("KeyEventProvider",function(){return new function(){function stringify($event){return _.compact([$event.ctrlKey?"Ctrl":"",$event.altKey?"Alt":"",$event.shiftKey?"Shift":"","Control"===$event.key&&$event.ctrlKey||"Alt"===$event.key&&$event.altKey||"Shift"===$event.key&&$event.shiftKey||"Meta"===$event.key&&$event.metaKey?"":$event.key]).join("+")||""}this.actions=[],this.$handleEvent=function($event){_.forEach(this.actions,function(action){stringify($event).match(action.matches)&&action.callback($event)}),stringify($event).match(/(Shift\+)?Escape/)&&$event.preventDefault()};var KeyEventProvider=this;$(document).on("keydown keyup keypress",function($event){KeyEventProvider.$handleEvent($event)})}}),module.factory("SessionProvider",[function(){return new function(){this.set=function(key,value){return sessionStorage.setItem(key,value)},this.get=function(key){return sessionStorage.getItem(key)},this.remove=function(key){return sessionStorage.removeItem(key)}}}]),module.factory("GamesResource",["RestfulService",function(RestfulService){return RestfulService("data/games.php",null,{load:{method:"POST",params:{action:"load"}}})}]),module.factory("UsersResource",["RestfulService",function(RestfulService){return RestfulService("data/users.php",null,{login:{method:"POST",params:{action:"login"}},logout:{method:"POST",params:{action:"logout"}},register:{method:"POST",params:{action:"register"}}})}]),module.config(["$qProvider","$resourceProvider",function($qProvider,$resourceProvider){$qProvider.errorOnUnhandledRejections(!1),$resourceProvider.defaults.cancellable=!0}]).service("RestfulService",["$resource",function($resource){return function(url,paramDefaults,actions){var resource=$resource.apply($resource,arguments);return resource.requests=resource.requests||{},resource.abort=function(method){return method&&resource.requests[method]?(resoure.requests[method].$cancelRequest(),delete resource.requests[method]):(_.invokeMap(resource.requests,"$cancelRequest"),resource.requests={}),resource},_.forEach(_.keys(actions),function(method){var original=resource[method];_.isFunction(original)&&(resource[method]=function(){return resource.requests[method]=original.apply(resource,arguments),resource.requests[method].$promise})}),resource}}]),module.config(["$stateProvider",function($stateProvider){$stateProvider.state("games",{abstract:!0,template:"<ui-view />"})}]),module.config(["$stateProvider",function($stateProvider){$stateProvider.state("games.load",{controller:"LoadController",templateUrl:"app/templates/games/load.html"})}]).controller("LoadController",["$scope","$state","GamesResource","KeyEventProvider","SessionProvider",function($scope,$state,GamesResource,KeyEventProvider,SessionProvider){$scope.model={userId:SessionProvider.get("userId")},$scope.flags={busy:!0},$scope.load=function(){},GamesResource.abort().load($scope.model).then(function(response){response.success?($scope.games=response.model,_.get($scope,"games[0]")&&($scope.model.gameId=$scope.games[0].id)):alert(response.message)}).catch(function(error){alert(error)}).finally(function(){$scope.flags.busy=!1}),KeyEventProvider.actions=[{matches:/(Shift\+)?Escape/,callback:function(){$state.transitionTo("games.menu")}}]}]),module.config(["$stateProvider",function($stateProvider){$stateProvider.state("games.menu",{controller:"GamesMenuController",templateUrl:"app/templates/games/menu.html"})}]).controller("GamesMenuController",["$scope","KeyEventProvider",function($scope,KeyEventProvider){KeyEventProvider.actions=[]}]),module.config(["$stateProvider",function($stateProvider){$stateProvider.state("games.new",{controller:"NewGameController",templateUrl:"app/templates/games/new.html"})}]).controller("NewGameController",["$scope","$state","KeyEventProvider","SessionProvider",function($scope,$state,KeyEventProvider,SessionProvider){$scope.model={userId:SessionProvider.get("userId")},KeyEventProvider.actions=[{matches:/(Shift\+)?Escape/,callback:function(){$state.transitionTo("games.menu")}}]}]),module.controller("RPGController",["$scope","$state","KeyEventProvider","SessionProvider",function($scope,$state,KeyEventProvider,SessionProvider){SessionProvider.get("userId")?$state.transitionTo("games.menu"):$state.transitionTo("users.login"),$scope.transitionTo=function(state){$state.transitionTo(state)}}]),module.config(["$stateProvider",function($stateProvider){$stateProvider.state("users.login",{controller:"LoginController",templateUrl:"app/templates/users/login.html"})}]).controller("LoginController",["$scope","$state","SessionProvider","UsersResource",function($scope,$state,SessionProvider,UsersResource){$scope.flags={busy:!1},$scope.login=function(){$scope.flags.busy=!0,UsersResource.abort().login($scope.model).then(function(response){response.success?(SessionProvider.set("userId",response.model.id),SessionProvider.set("userName",response.model.name),$state.transitionTo("games.menu")):alert(response.error)}).catch(function(error){alert(error)}).finally(function(){$scope.flags.busy=!1})}}]),module.config(["$stateProvider",function($stateProvider){$stateProvider.state("users.logout",{controller:"LogoutController"})}]).controller("LogoutController",["$state","SessionProvider","UsersResource",function($state,SessionProvider,UsersResource){UsersResource.abort().logout().then(function(response){response.success?(SessionProvider.remove("userId"),$state.transitionTo("users.login")):alert(response.message)}).catch(function(error){alert(error)})}]),module.config(["$stateProvider",function($stateProvider){$stateProvider.state("users.register",{controller:"RegisterController",templateUrl:"app/templates/users/register.html"})}]).controller("RegisterController",["$scope","$state","KeyEventProvider","SessionProvider","UsersResource",function($scope,$state,KeyEventProvider,SessionProvider,UsersResource){$scope.flags={busy:!1},$scope.register=function(){console.log($scope.model),$scope.model.pass===$scope.model.pass2?($scope.flags.busy=!0,UsersResource.abort().register($scope.model).then(function(response){response.success?(SessionProvider.set("userId",response.model.id),SessionProvider.set("userName",response.model.name),$state.transitionTo("games.menu")):alert(response.error)}).catch(function(error){alert(error)}).finally(function(){$scope.flags.busy=!1})):alert("The passwords do not match.")},KeyEventProvider.actions=[{matches:/(Shift\+)?Escape/,callback:function(){$state.transitionTo("users.login")}}]}]),module.config(["$stateProvider",function($stateProvider){$stateProvider.state("users",{abstract:!0,template:"<ui-view />"})}])}(angular.module("rpg",["ngResource","ui.router"])),angular.module("rpg").run(["$templateCache",function($templateCache){"use strict";$templateCache.put("app/templates/games/load.html",'<dialog><form ng-submit=load()><header><a ui-sref=games.menu><i class="fa fa-times"></i></a> Load Game</header><main><ul style="height: 160px;"><li ng-class="{ active: model.gameId == game.id }" ng-repeat="game in games"><label class=input-checkbox><input ng-model=model.gameId ng-value=game.id type=radio /> {{ game.title }}</label></li></ul></main><footer><button ng-disabled="flags.busy || !model.gameId" type=submit>Load Game</button></footer></form></dialog>'),$templateCache.put("app/templates/games/menu.html","<dialog class=transparent><main><nav><button ng-click=\"transitionTo('games.load');\" type=submit>Load Game</button> <button ng-click=\"transitionTo('games.new')\" type=submit>New Game</button> <button disabled type=submit>Help</button> <button ng-click=\"transitionTo('users.logout');\" type=submit>Log Out</button></nav></main></dialog>"),$templateCache.put("app/templates/games/new.html",'<dialog><form ng-submit=new()><header><a ui-sref=games.menu><i class="fa fa-times"></i></a> New Game</header><main></main><footer><button ng-disabled="flags.busy || !model.gameId" type=submit>New Game</button></footer></form></dialog>'),$templateCache.put("app/templates/users/login.html",'<dialog><form name=loginForm ng-submit=login()><header>Log In</header><main><input style="display: none;"/> <input style="display: none;" type=password /> <label class=input-group><i class="fa fa-user"></i> <input ng-disabled=flags.busy ng-model=model.user placeholder=Username required/></label> <label class=input-group><i class="fa fa-key"></i> <input ng-disabled=flags.busy ng-model=model.pass placeholder=Password required type=password /></label></main><footer><button ng-disabled=flags.busy ng-click="transitionTo(\'users.register\');" type=reset>Register</button> <button ng-disabled="flags.busy || loginForm.$invalid" type=submit>Log In</button></footer></form></dialog>'),$templateCache.put("app/templates/users/register.html",'<dialog><form name=registerForm ng-submit=register()><header><a ui-sref=users.login><i class="fa fa-times"></i></a> Register</header><main><input style="display: none;"/> <input style="display: none;" type=password /> <label class=input-group><i class="fa fa-user"></i> <input ng-disabled=flags.busy ng-model=model.user placeholder=Username required/></label> <label class=input-group><i class="fa fa-envelope"></i> <input ng-disabled=flags.busy ng-model=model.email placeholder=Email required type=email /></label> <label class=input-group><i class="fa fa-key"></i> <input ng-disabled=flags.busy ng-model=model.pass placeholder=Password required type=password /></label> <label class=input-group><i class="fa fa-key"></i> <input ng-disabled=flags.busy ng-model=model.pass2 placeholder="Password (again)" required type=password /></label></main><footer><button ng-disabled="flags.busy || registerForm.$invalid || model.pass !== model.pass2" type=submit>Register</button></footer></form></dialog>')}]);