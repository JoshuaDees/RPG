!function(module){module.factory("DialogService",function(){return $(window).on("resize",function(){$("dialog").each(function(index,dialog){dialog.close(),dialog.showModal()})}),{}}).directive("dialog",["$timeout","DialogService",function($timeout,DialogService){return{restrict:"E",link:function($scope,$element){$timeout(function(){$element[0].showModal()})}}}]),module.factory("ErrorProvider",[function(){return new function(){this.alert=function(error){$(document.body).append('<dialog modal id="error"><header><a onclick="$(\'#error\').remove();" ui-sref><i class="fa fa-times"></i></a>Error</header><main>'+error+'</main><footer><button onclick="$(\'#error\').remove();" type="submit">Close</button></footer></dialog>'),$("#error")[0].showModal()}}}]),module.factory("KeyEventProvider",function(){return new function(){function stringify($event){return _.compact([$event.ctrlKey?"Ctrl":"",$event.altKey?"Alt":"",$event.shiftKey?"Shift":"","Control"===$event.key&&$event.ctrlKey||"Alt"===$event.key&&$event.altKey||"Shift"===$event.key&&$event.shiftKey||"Meta"===$event.key&&$event.metaKey?"":$event.key]).join("+")||""}this.actions=[],this.$handleEvent=function($event){var str,match;_.forEach(this.actions,function(action){_.forEach(action.matches,function(regex){str=stringify($event),(match=str.match(new RegExp("^"+regex+"$")))&&match[0]&&str==match[0]&&action.callback(match[0])})}),stringify($event).match(/(Shift\+)?Escape/)&&($("#error").remove(),$event.preventDefault())};var KeyEventProvider=this;$(document).on("keydown",function($event){KeyEventProvider.$handleEvent($event)})}}),module.factory("SessionProvider",[function(){return new function(){this.set=function(key,value){return sessionStorage.setItem(key,value)},this.get=function(key){return sessionStorage.getItem(key)},this.remove=function(key){return sessionStorage.removeItem(key)}}}]),module.factory("CharactersResource",["RestfulService",function(RestfulService){return RestfulService("data/characters.php",null,{classes:{method:"POST",params:{action:"classes"}},genders:{method:"POST",params:{action:"genders"}},races:{method:"POST",params:{action:"races"}}})}]),module.factory("GamesResource",["RestfulService",function(RestfulService){return RestfulService("data/games.php",null,{load:{method:"POST",params:{action:"load"}}})}]),module.factory("UsersResource",["RestfulService",function(RestfulService){return RestfulService("data/users.php",null,{login:{method:"POST",params:{action:"login"}},logout:{method:"POST",params:{action:"logout"}},register:{method:"POST",params:{action:"register"}}})}]),module.config(["$qProvider","$resourceProvider",function($qProvider,$resourceProvider){$qProvider.errorOnUnhandledRejections(!1),$resourceProvider.defaults.cancellable=!0}]).service("RestfulService",["$resource",function($resource){return function(url,paramDefaults,actions){var resource=$resource.apply($resource,arguments);return resource.requests=resource.requests||{},resource.abort=function(method){return method&&resource.requests[method]?(resoure.requests[method].$cancelRequest(),delete resource.requests[method]):(_.invokeMap(resource.requests,"$cancelRequest"),resource.requests={}),resource},_.forEach(_.keys(actions),function(method){var original=resource[method];_.isFunction(original)&&(resource[method]=function(){return resource.requests[method]=original.apply(resource,arguments),resource.requests[method].$promise})}),resource}}]),module.config(["$stateProvider",function($stateProvider){$stateProvider.state("games",{abstract:{},scope:!0,template:"<ui-view />",controller:["$scope","GamesResource","KeyEventProvider","SessionProvider",function($scope,GamesResource,KeyEventProvider,SessionProvider){$scope.model={userId:SessionProvider.get("userId")},$scope.flags={busy:!0},GamesResource.abort().load($scope.model).then(function(response){response.success?($scope.games=response.model,_.get($scope,"games[0]")&&($scope.model.gameId=$scope.games[0].id)):alert(response.message)}).catch(function(error){alert(error)}).finally(function(){$scope.flags.busy=!1}),KeyEventProvider.actions=[]}]})}]),module.config(["$stateProvider",function($stateProvider){$stateProvider.state("games.load",{scope:{},templateUrl:"app/templates/games/load.html",controller:["$scope","$state","GamesResource","KeyEventProvider","SessionProvider",function($scope,$state,GamesResource,KeyEventProvider,SessionProvider){$scope.load=function(){},KeyEventProvider.actions=[{matches:["Shift+Escape","Escape"],callback:function(){$state.transitionTo("games.menu")}}]}]})}]),module.config(["$stateProvider",function($stateProvider){$stateProvider.state("games.menu",{scope:{},templateUrl:"app/templates/games/menu.html",controller:["$scope","$state","KeyEventProvider",function($scope,$state,KeyEventProvider){KeyEventProvider.actions=[{matches:["l"],callback:function(){$state.transitionTo("games.load")}},{matches:["n"],callback:function(){$state.transitionTo("games.new.party")}}]}]})}]),module.config(["$stateProvider",function($stateProvider){$stateProvider.state("games.new.character.abilities",{scope:{},templateUrl:"app/templates/games/new/character/abilities.html",controller:["$scope","$state","$stateParams","KeyEventProvider",function($scope,$state,$stateParams,KeyEventProvider){KeyEventProvider.actions=[{matches:["Shift+Escape","Escape"],callback:function(){$state.transitionTo("games.new.character.details",{model:$scope.$parent.model})}}]}]})}]),module.config(["$stateProvider",function($stateProvider){$stateProvider.state("games.new.character",{abstract:!0,scope:{},templateUrl:"app/templates/games/new/character/character.html",params:{model:null},controller:["$scope","$state","$stateParams","KeyEventProvider",function($scope,$state,$stateParams,KeyEventProvider){$scope.model=$stateParams.model||{},KeyEventProvider.actions=[{matches:["Shift+Escape","Escape"],callback:function(){$state.transitionTo("games.new.party")}}],$scope.update=function(property,value){_.set($scope,"model."+property,value),$state.transitionTo("games.new.character.details",{model:$scope.model})},_.forEach(["race","class","attributes","skills","name"],function(attribute){if(!_.get($scope,"model."+attribute))return $state.transitionTo("games.new.character."+attribute,{model:$scope.model}),!1})}]})}]),module.config(["$stateProvider",function($stateProvider){$stateProvider.state("games.new.character.class",{scope:{},templateUrl:"app/templates/games/new/character/class.html",controller:["$scope","$state","$stateParams","$timeout","CharactersResource","KeyEventProvider",function($scope,$state,$stateParams,$timeout,CharactersResource,KeyEventProvider){$scope.model={items:[],selected:null},$scope.flags={busy:!0},$scope.accept=function(){$scope.$parent.update("class",$scope.model.selected)},CharactersResource.abort().classes().then(function(response){response.success?($scope.model.items=response.model,$scope.model.selected=_.filter($scope.model.items,function(current,index){var selected=_.get($scope.$parent,"model.class.id");return selected?current.id==selected:0==index})[0],$timeout(function(){$("[type=radio]"+($("[type=radio][checked]").length?"[checked]":"")).first().focus()})):alert(response.message)}).catch(function(error){alert(error)}).finally(function(){$scope.flags.busy=!1}),KeyEventProvider.actions=[{matches:["Shift+Escape","Escape"],callback:function(){$state.transitionTo("games.new.character.details",{model:$scope.$parent.model})}}]}]})}]),module.config(["$stateProvider",function($stateProvider){$stateProvider.state("games.new.character.details",{state:{},controller:["$scope","$state","KeyEventProvider",function($scope,$state,KeyEventProvider){KeyEventProvider.actions=[{matches:["Shift+Escape","Escape"],callback:function(){$state.transitionTo("games.new.party")}},{matches:["g|r|c|a|s|n"],callback:function(match){console.log("g"),$state.transitionTo("games.new.character."+{g:"gender",r:"race",c:"class",a:"abilities",s:"skills",n:"name"}[match],{model:$scope.$parent.model})}}]}]})}]),module.config(["$stateProvider",function($stateProvider){$stateProvider.state("games.new.character.gender",{scope:{},templateUrl:"app/templates/games/new/character/gender.html",controller:["$scope","$state","$stateParams","$timeout","CharactersResource","KeyEventProvider",function($scope,$state,$stateParams,$timeout,CharactersResource,KeyEventProvider){$scope.model={items:[],selected:null},$scope.flags={busy:!0},$scope.accept=function(){$scope.$parent.update("gender",$scope.model.selected)},CharactersResource.abort().genders().then(function(response){response.success?($scope.model.items=response.model,$scope.model.selected=_.filter($scope.model.items,function(current,index){var selected=_.get($scope.$parent,"model.gender.id");return selected?current.id==selected:0==index})[0],$timeout(function(){$("[type=radio]"+($("[type=radio][checked]").length?"[checked]":"")).first().focus()})):alert(response.message)}).catch(function(error){alert(error)}).finally(function(){$scope.flags.busy=!1}),KeyEventProvider.actions=[{matches:["Shift+Escape","Escape"],callback:function(){$state.transitionTo("games.new.character.details",{model:$scope.$parent.model})}}]}]})}]),module.config(["$stateProvider",function($stateProvider){$stateProvider.state("games.new.character.name",{scope:{},templateUrl:"app/templates/games/new/character/name.html",controller:["$scope","$state","$stateParams","KeyEventProvider",function($scope,$state,$stateParams,KeyEventProvider){$scope.model={selected:_.get($scope.$parent,"model.name")},$scope.accept=function(){$scope.$parent.update("name",$scope.model.selected)},KeyEventProvider.actions=[{matches:["Shift+Escape","Escape"],callback:function(){$state.transitionTo("games.new.character.details",{model:$scope.$parent.model})}}]}]})}]),module.config(["$stateProvider",function($stateProvider){$stateProvider.state("games.new.character.race",{scope:{},templateUrl:"app/templates/games/new/character/race.html",controller:["$scope","$state","$stateParams","$timeout","CharactersResource","KeyEventProvider",function($scope,$state,$stateParams,$timeout,CharactersResource,KeyEventProvider){$scope.model={items:[],selected:null},$scope.flags={busy:!0},$scope.accept=function(){$scope.$parent.update("race",$scope.model.selected)},CharactersResource.abort().races().then(function(response){response.success?($scope.model.items=response.model,$scope.model.selected=_.filter($scope.model.items,function(current,index){var selected=_.get($scope.$parent,"model.race.id");return selected?current.id==selected:0==index})[0],$timeout(function(){$("[type=radio]"+($("[type=radio][checked]").length?"[checked]":"")).first().focus()})):alert(response.message)}).catch(function(error){alert(error)}).finally(function(){$scope.flags.busy=!1}),KeyEventProvider.actions=[{matches:["Shift+Escape","Escape"],callback:function(){$state.transitionTo("games.new.character.details",{model:$scope.$parent.model})}}]}]})}]),module.config(["$stateProvider",function($stateProvider){$stateProvider.state("games.new",{abstract:!0,scope:{},template:"<ui-view />",controller:["$scope","$state","KeyEventProvider","SessionProvider",function($scope,$state,KeyEventProvider,SessionProvider){$scope.model={userId:SessionProvider.get("userId"),characters:[{name:"Crag Hack",gender:{id:1,name:"Male"},race:{id:6,name:"Half-Orc"},class:{id:1,name:"Barbarian"},portrait:"half-orc.male.1",abilities:{might:15,intellect:7,personality:9,endurance:13,accuracy:9,speed:11},skills:[]},{},{},{},{},{}]},$scope.isTeamFull=function(){return 6===_.filter($scope.model.characters,function(character){return character.name}).length},KeyEventProvider.actions=[]}]})}]),module.config(["$stateProvider",function($stateProvider){$stateProvider.state("games.new.party",{scope:{},templateUrl:"app/templates/games/new/party.html",controller:["$scope","$state","KeyEventProvider",function($scope,$state,KeyEventProvider){KeyEventProvider.actions=[{matches:["Shift+Escape","Escape"],callback:function(){$state.transitionTo("games.menu")}},{matches:["1|2|3|4|5|6"],callback:function(match){$state.transitionTo("games.new.character.details",{model:$scope.$parent.model.characters[match-1]})}}]}]})}]),module.controller("RPGController",["$scope","$state","KeyEventProvider","SessionProvider",function($scope,$state,KeyEventProvider,SessionProvider){SessionProvider.get("userId")?$state.transitionTo("games.menu"):$state.transitionTo("users.login"),$scope.transitionTo=function(state,params){$state.transitionTo(state,params)}}]),module.config(["$stateProvider",function($stateProvider){$stateProvider.state("users.login",{scope:{},templateUrl:"app/templates/users/login.html",controller:["$scope","$state","ErrorProvider","KeyEventProvider","SessionProvider","UsersResource",function($scope,$state,ErrorProvider,KeyEventProvider,SessionProvider,UsersResource){$scope.flags={busy:!1},$scope.login=function(){$scope.flags.busy=!0,UsersResource.abort().login($scope.model).then(function(response){response.success?(SessionProvider.set("userId",response.model.id),SessionProvider.set("userName",response.model.name),$state.transitionTo("games.menu")):ErrorProvider.alert(response.error)}).catch(function(error){alert(error)}).finally(function(){$scope.flags.busy=!1}),KeyEventProvider.actions=[]}}]})}]),module.config(["$stateProvider",function($stateProvider){$stateProvider.state("users.logout",{scope:{},controller:["$state","KeyEventProvider","SessionProvider","UsersResource",function($state,KeyEventProvider,SessionProvider,UsersResource){UsersResource.abort().logout().then(function(response){response.success?(SessionProvider.remove("userId"),$state.transitionTo("users.login")):alert(response.message)}).catch(function(error){alert(error)}),KeyEventProvider.actions=[]}]})}]),module.config(["$stateProvider",function($stateProvider){$stateProvider.state("users.register",{scope:{},templateUrl:"app/templates/users/register.html",controller:["$scope","$state","KeyEventProvider","SessionProvider","UsersResource",function($scope,$state,KeyEventProvider,SessionProvider,UsersResource){$scope.flags={busy:!1},$scope.register=function(){console.log($scope.model),$scope.model.pass===$scope.model.pass2?($scope.flags.busy=!0,UsersResource.abort().register($scope.model).then(function(response){response.success?(SessionProvider.set("userId",response.model.id),SessionProvider.set("userName",response.model.name),$state.transitionTo("games.menu")):alert(response.error)}).catch(function(error){alert(error)}).finally(function(){$scope.flags.busy=!1})):alert("The passwords do not match.")},KeyEventProvider.actions=[{matches:["Shift+Escape","Escape"],callback:function(){$state.transitionTo("users.login")}}]}]})}]),module.config(["$stateProvider",function($stateProvider){$stateProvider.state("users",{abstract:!0,scope:{},template:"<ui-view />"})}])}(angular.module("rpg",["ngResource","ui.router"])),angular.module("rpg").run(["$templateCache",function($templateCache){"use strict";$templateCache.put("app/templates/games/load.html",'<h2>Load Game</h2><dialog><form ng-submit=load()><header><a ui-sref=games.menu><i class="fa fa-times"></i></a> Load Game</header><main><ul style="height: 160px;"><li ng-class="{ active: $parent.model.gameId == game.id }" ng-repeat="game in $parent.games"><label class=input-checkbox><input name=game ng-model=$parent.model.gameId ng-value=game.id type=radio /> {{ game.title }}</label></li></ul></main><footer><button ng-disabled="flags.busy || !$parent.model.gameId" type=submit>Load Game</button></footer></form></dialog>'),$templateCache.put("app/templates/games/menu.html","<h2>Menu</h2><dialog class=transparent><nav><button ng-click=\"transitionTo('games.load');\" ng-disabled=!$parent.model.gameId type=submit>Load Game</button> <button ng-click=\"transitionTo('games.new.party')\" type=submit>New Game</button> <button disabled>Options</button> <button disabled>Help</button> <button ng-click=\"transitionTo('users.logout');\" type=submit>Log Out</button></nav></dialog>"),$templateCache.put("app/templates/games/new/character/abilities.html",'<dialog modal><form ng-submit=accept()><header><a ui-sref="games.new.character.details({ model: $parent.model })"><i class="fa fa-times"></i></a> Select Abilities</header><main><div ng-repeat="ability in [\'might\', \'intellect\', \'personality\', \'endurance\', \'accuracy\', \'speed\']"><label class=text-right style="display: inline-block; width: 96px; text-transform: capitalize;">{{ ability }}:</label> <input class=text-center style="width: 64px;" disabled value=11 /> <input class=text-center style="width: 64px;" disabled value=+1 /> <button style="min-width: 32px;"><i class="fa fa-plus"></i></button> <button style="min-width: 32px;"><i class="fa fa-minus"></i></button></div></main><footer><button type=submit>Accept</button></footer></form></dialog>'),$templateCache.put("app/templates/games/new/character/character.html",'<h2>Create Character</h2><dialog><form><header><a ui-sref=games.new.party><i class="fa fa-times"></i></a> Create Character</header><main><article style="width: 832px;"><aside><nav class=compact><button onfocus=this.blur(); ng-click="transitionTo(\'games.new.character.gender\', { model: model })">Gender</button> <button ng-disabled=!model.gender onfocus=this.blur(); ng-click="transitionTo(\'games.new.character.race\', { model: model })">Race</button> <button ng-disabled=!model.race onfocus=this.blur(); ng-click="transitionTo(\'games.new.character.class\', { model: model })">Class</button> <button ng-disabled=!model.class onfocus=this.blur(); ng-click="transitionTo(\'games.new.character.abilities\', { model: model })">Abilities</button> <button ng-disabled=!model.abilities onfocus=this.blur(); ng-click="transitionTo(\'games.new.character.skills\', { model: model })">Skills</button> <button ng-disabled=!model.skills onfocus=this.blur(); ng-click="transitionTo(\'games.new.character.name\', { model: model })">Name</button></nav></aside><section class=border><p ng-if=model.name><b>Name:</b> {{ model.name }}</p><p ng-if=model.gender><b>Gender:</b> {{ model.gender.name }}</p><p ng-if=model.race><b>Race:</b> {{ model.race.name }}</p><p ng-if=model.class><b>Class:</b> {{ model.class.name }}</p><p ng-if=model.abilities><b>Abilities:</b> Mgt: {{ model.abilities.might }}, Int: {{ model.abilities.intellect }}, Per: {{ model.abilities.personality }}, End: {{ model.abilities.endurance }}, Acc: {{ model.abilities.accuracy }}, Spd: {{ model.abilities.speed }}</p><p ng-if=model.skills><b>Skills:</b> Bastard Sword, Plate Armor, Shield, Body Building</p></section><aside><figure><img class="portrait large" ng-if=model.portrait ng-src="./media/images/characters/portraits/{{ model.portrait }}.jpg"/> <img class="portrait large" ng-if=!model.portrait ng-src=./media/images/transparent.gif /></figure></aside></article></main><footer><button disabled type=submit>Create</button></footer></form></dialog><ui-view/>'),$templateCache.put("app/templates/games/new/character/class.html",'<dialog modal><form ng-submit=accept()><header><a ui-sref="games.new.character.details({ model: $parent.model })"><i class="fa fa-times"></i></a> Select Class</header><main><article style="height: 360px; width: 640px;"><aside style="width: 160px;"><ul style="height: 100%;"><li ng-class="{ active: model.selected == item }" ng-repeat="item in model.items"><label class=input-checkbox><input name=class ng-model=model.selected ng-value=item type=radio /> {{ item.name }}</label></li></ul></aside><section class=border><p>{{ model.selected.description }}</p></section></article></main><footer><button type=submit>Accept</button></footer></form></dialog>'),$templateCache.put("app/templates/games/new/character/gender.html",'<dialog modal><form ng-submit=accept()><header><a ui-sref="games.new.character.details({ model: $parent.model })"><i class="fa fa-times"></i></a> Select Gender</header><main style="height: 66px;"><ul><li ng-class="{ active: model.selected == item }" ng-repeat="item in model.items track by $index"><label class=input-checkbox><input name=gender ng-model=model.selected ng-value=item type=radio /> {{ item.name }}</label></li></ul></main><footer><button type=submit>Accept</button></footer></form></dialog>'),$templateCache.put("app/templates/games/new/character/name.html",'<dialog modal><form ng-submit=accept()><header><a ui-sref="games.new.character.details({ model: $parent.model })"><i class="fa fa-times"></i></a> Select Name</header><main class=row><input class="flex text-center" maxlength=45 ng-model=model.selected placeholder="Character Name"/></main><footer><button type=submit>Accept</button></footer></form></dialog>'),$templateCache.put("app/templates/games/new/character/race.html",'<dialog modal><form ng-submit=accept()><header><a ui-sref="games.new.character.details({ model: $parent.model })"><i class="fa fa-times"></i></a> Select Race</header><main><article style="height: 360px; width: 640px;"><aside style="width: 160px;"><ul style="height: 100%;"><li ng-class="{ active: model.selected == item }" ng-repeat="item in model.items track by $index"><label class=input-checkbox><input name=race ng-checked="model.selected.id === item.id" ng-model=model.selected ng-value=item type=radio /> {{ item.name }}</label></li></ul></aside><section class=border><p>{{ model.selected.description }}</p></section></article></main><footer><button type=submit>Accept</button></footer></form></dialog>'),$templateCache.put("app/templates/games/new/party.html",'<h2>New Game</h2><dialog><form><header><a ui-sref=games.menu><i class="fa fa-times"></i></a> Create Party</header><main><figure ng-repeat="x in [].constructor(6) track by $index"><img class=portrait ng-if-start=$parent.model.characters[$index].name ng-src="./media/images/characters/portraits/{{ $parent.model.characters[$index].race.name }}.{{ $parent.model.characters[$index].gender.name }}.1.jpg"/><figcaption ng-if-end><p><b>{{ $parent.model.characters[$index].name }}</b><br/><small>{{ $parent.model.characters[$index].race.name }} {{ $parent.model.characters[$index].class.name }}</small></p><nav class=compact><button ui-sref="games.new.character.details({ model: $parent.model.characters[$index] })">Edit</button></nav></figcaption><img class=portrait ng-if-start=!$parent.model.characters[$index].name src=./media/images/transparent.gif /><figcaption ng-if-end><p>&nbsp;<br/><small>&nbsp;</small></p><nav class=compact><button ui-sref="games.new.character.details({ model: $parent.model.characters[$index] })">Create</button></nav></figcaption></figure></main><footer><button ng-disabled=!$parent.isTeamFull() type=submit>Start Game</button></footer></form></dialog>'),$templateCache.put("app/templates/users/login.html",'<h2>Log In</h2><dialog><form name=loginForm ng-submit=login()><header>Log In</header><main><input style="display: none;"/> <input style="display: none;" type=password /> <label class=input-group><i class="fa fa-user"></i> <input maxlength=45 ng-disabled=flags.busy ng-model=model.user placeholder=Username required/></label> <label class=input-group><i class="fa fa-key"></i> <input maxlength=45 ng-disabled=flags.busy ng-model=model.pass placeholder=Password required type=password /></label><div class="input-helper text-right"><a href=javascript:;>Forgot Password?</a></div></main><footer><button ng-disabled=flags.busy ng-click="transitionTo(\'users.register\');" type=reset>Register</button> <button ng-disabled="flags.busy || loginForm.$invalid" type=submit>Log In</button></footer></form></dialog>'),$templateCache.put("app/templates/users/register.html",'<h2>Register</h2><dialog><form name=registerForm ng-submit=register()><header><a ui-sref=users.login><i class="fa fa-times"></i></a> Register</header><main><input style="display: none;"/> <input style="display: none;" type=password /> <label class=input-group><i class="fa fa-user"></i> <input maxlength=45 ng-disabled=flags.busy ng-model=model.user placeholder=Username required/></label> <label class=input-group><i class="fa fa-envelope"></i> <input maxlength=45 ng-disabled=flags.busy ng-model=model.email placeholder=Email required type=email /></label> <label class=input-group><i class="fa fa-key"></i> <input maxlength=45 ng-disabled=flags.busy ng-model=model.pass placeholder=Password required type=password /></label> <label class=input-group><i class="fa fa-key"></i> <input maxlength=45 ng-disabled=flags.busy ng-model=model.pass2 placeholder="Password (again)" required type=password /></label></main><footer><button ng-disabled="flags.busy || registerForm.$invalid || model.pass !== model.pass2" type=submit>Register</button></footer></form></dialog>')}]);